---
title: "CVD Project - Aim 1 - Notebook"
author: "Tamy Tsujimoto"
date: "`r format(Sys.time(), '%m/%d/%Y')`"
output: 
  html_document:
    toc: yes
    toc_float: yes
    theme: paper 
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Project Summary 

## Overview

In the proposed proof of concept study, we will determine if adding specific adverse pregnancy outcomes (APOs) as risk factors to the ACC/AHA Pooled Cohort Equations (ACC/AHA PCE) improves cardiovascular (CVD) risk prediction in women.

## Goal

Aim 1: Examine if adding pre-term delivery or gestational diabetes to the traditional risk factors in the ACC/AHA PCE improves risk prediction compared with traditional risk factors alone, using a national prospective cohort.

## Study Sample

* Women
* ages 40 - 79 years
* At least one pregnancy
* No existing cardiovascular disease at baseline
    
## Outcome

CVD-specific death.

## ACC/AHA PCE

* Reference: [2013 ACC/AHA Guideline on the Assessment of Cardiovascular Risk](https://www.ahajournals.org/doi/pdf/10.1161/01.cir.0000437741.48606.98)
* [2018 Prevention Guidelines Tool CV Risk Calculator](http://static.heart.org/riskcalc/app/index.html#!/baseline-risk)
* Sex and race specific equations to predict 10-year risk for first ASCVD event
* Ten-year risk was defined as the risk of developing a first ASCVD event, defined as nonfatal myocardial infarction (MI) or coronary heart disease (CHD) death, or fatal or nonfatal stroke, over a 10-year period among people free from ASCVD at the beginning of the period
* The ASCVD risk estimates were developed from sex-and race-specific proportional hazards models that included the covariates of age, treated or untreated systolic blood pressure (SBP), total cholesterol, high-density lipoprotein cholesterol (HDL-C), current smoking (Y/N), and diabetes (Y/N)
* End points were censored at 12 years, and model fit was evaluated through the area under the receiver operating curve (C-statistic) for discrimination and the calibration chi-squared statistic

## Data sources

* [National Health and Nutrition Examination Survey (NHANES)](https://wwwn.cdc.gov/nchs/nhanes/Default.aspx)
    + Continuous NHANES datasets (2 years) - 1999-2014
    +	Databases (119)
        + Demographics (1)
        + Dietary (8)
        + Examination (18)
        + Laboratory (48)
        + Questionnaire (44)
    + [NHANES Survey Methods and Analytic Guidelines](https://wwwn.cdc.gov/nchs/nhanes/analyticguidelines.aspx)
        + Plans and Operations
        + Sample Design
        + Estimation and Weight Procedures
        + Analytic guidelines
            + [NHANES Analytic Guidelines 1999-2010](https://www.cdc.gov/nchs/data/series/sr_02/sr02_161.pdf)
            + [NHANES Analytic Guidelines 2011-2016](https://wwwn.cdc.gov/nchs/data/nhanes/2011-2012/analyticguidelines/analytic_guidelines_11_16.pdf)

* [NDI Mortality Files](https://www.cdc.gov/nchs/data-linkage/mortality.htm)
    + [File Description](https://www.cdc.gov/nchs/data/datalinkage/public-use-2015-linked-mortality-file-description.pdf)
    + [Public-Use Data Dictionary](https://www.cdc.gov/nchs/data/datalinkage/public-use-2015-linked-mortality-files-data-dictionary.pdf)
    + [Mortality Files](ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/)
    

# Data Assembly

## Tasks and deadlines

| Task                                                       | Deadline   |
|------------------------------------------------------------|------------|
| Shortlist variables/datasets that will be used from NHANES |            |
| Download NHANES files (1999-2014)                          | 05/01/2019 |
| Merge NHANES files and construct survey weights            | 06/01/2019 |
| Merge with mortality data                                  | 06/01/2019 |
| Select target population                                   | 06/01/2019 |
| Data quality checks                                        | 07/01/2019 |

Next steps: Variable construction

## Data extraction 

### Downloading NHANES data

Using the [R package RNHANES](https://cran.r-project.org/web/packages/RNHANES/vignettes/introduction.html) to download the datasets. 

```{r eval=FALSE}

library(RNHANES)
library(tidyverse)

# Years considered in the analysis (1999-2014)
yr = paste(seq(1999, 2013, by = 2), seq(2000, 2014, by = 2), sep = "-")

# Demographic Variables & Sample Weights
nhanes_load_data(file = "DEMO", 
                 year = yr, 
                 destination = "nhanes_data")

# Blood Pressure
nhanes_load_data(file = "BPX", 
                 year = yr, 
                 destination = "nhanes_data")

# Blood Pressure & Cholesterol
nhanes_load_data(file = "BPQ", 
                 year = yr, 
                 destination = "nhanes_data")

# Smoking - Cigarette/Tobacco Use - Adult 
nhanes_load_data(file = "SMQ", 
                 year = yr, 
                 destination = "nhanes_data")

# Diabetes
nhanes_load_data(file = "DIQ", 
                 year = yr, 
                 destination = "nhanes_data")

# Reproductive Health 
nhanes_load_data(file = "RHQ", 
                 year = yr, 
                 destination = "nhanes_data")

# Cholesterol 
nhanes_load_data(file = c('Lab13', 'l13_B', 'l13_C', rep('TCHOL', 5)), 
                 year = yr, 
                 destination = "nhanes_data")

nhanes_load_data(file = 'HDL', 
                 year = yr[-c(1:3)], 
                 destination = "nhanes_data")

# Cotinine 
nhanes_load_data(file = c('LAB06', 'L06_B', 'L06COT_C', 'COT_D', 'COTNAL_E', 'COTNAL_F', 'COTNAL_G', 'COT_H'), 
                 year = yr, 
                 destination = "nhanes_data")

# Glycohemoglobin 
nhanes_load_data(file = c('LAB10', 'L10_B', 'L10_C', rep('GHB', 5)), 
                 year = yr, 
                 destination = "nhanes_data")

# Medical Conditions 
nhanes_load_data(file = "MCQ", 
                 year = yr, 
                 destination = "../3 - Databases/nhanes_data")

# Oral Glucose Tolerance Test 
nhanes_load_data(file = 'OGTT', 
                 year = yr[-c(1:3)], 
                 destination = "../3 - Databases/nhanes_data")

# Plasma Fasting Glucose
nhanes_load_data(file = c('LAB10AM', 'L10AM_B', 'L10AM_C', rep('GLU', 5)), 
                 year = yr, 
                 destination = "../3 - Databases/nhanes_data")
```

### Variable extraction

Stack each variable and select variables of interest as described in Database and variable inventory file.

```{r include = FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(summarytools)
```

```{r}

# Path for the downloaded datasets
data_path = '../3 - Databases/nhanes_data'

# Function to stack NHANES dataset
stack_nhanes_data = function(path = data_path, pattern){
  
  data_names = list.files(path = path, pattern = pattern)
  
  db = 
    lapply(paste(path, data_names, sep = '/'), data.table::fread) %>% 
    bind_rows()
  
  return(db)
}

# Stacking nhanes datasets and selecting variables of interest:

# Demographic Variables & Sample Weights
demo = 
  stack_nhanes_data(pattern = 'DEMO') %>% 
  select(SEQN,
         cycle,
         RIAGENDR,
         RIDRETH1,
         RIDRETH2,
         RIDRETH3,
         RIDAGEYR,
         RIDAGEMN,
         RIDAGEEX,
         RIDEXPRG,
         WTINT2YR,
         WTMEC2YR)

# Blood Pressure
bpx = 
  stack_nhanes_data(pattern = 'BPX') %>% 
  select(SEQN,
         cycle,
         BPXSY1,
         BPXSY2,
         BPXSY3,
         BPXSY4,
         BPXSAR,
         BPXDI1,
         BPXDI2,
         BPXDI3,
         BPXDI4,
         BPAEN1,
         BPAEN2,
         BPAEN3,
         BPAEN4)

# Blood Pressure & Cholesterol
bpq = 
  stack_nhanes_data(pattern = 'BPQ') %>% 
  select(SEQN,
         cycle,
         BPQ080,
         BPQ020,
         BPQ030,
         BPQ040A,
         BPQ050A,
         BPQ100D)

# Smoking - Cigarette/Tobacco Use - Adult 
smq = 
  stack_nhanes_data(pattern = 'SMQ') %>% 
  select(SEQN,
         cycle,
         SMQ020,
         SMQ040,
         SMQ050Q,
         SMQ050U)

# Diabetes  
diq = 
  stack_nhanes_data(pattern = 'DIQ') %>% 
  select(SEQN,
         cycle,
         DIQ010,
         DIQ050,
         DIQ070,
         DID070,
         DIQ280)

# Reproductive Health          
rhq = 
  stack_nhanes_data(pattern = 'RHQ') %>% 
  select(SEQN,
         cycle,
         RHQ031,
         RHD042,
         #RHQ135C,
         RHD152,
         #RHQ165,
         RHQ166,
         RHQ169,
         RHQ171,
         #RHQ175,
         RHQ180,
         RHQ190,
         #RHQ195,
         RHD130,
         RHQ131,
         RHQ140,
         RHQ141,
         RHD143,
         RHQ160,
         RHD170,
         RHQ171,
         RHD270,
         RHQ250,
         RHQ260,
         RHQ210,
         RHD230,
         RHQ162)

# Cholesterol 
chol = 
  stack_nhanes_data(pattern = paste(c('Lab13', 'l13_b', 'l13_c', 'TCHOL'), collapse = "|")) %>% 
  select(SEQN,
         cycle,
         LBXTC,
         LBDHDL,
         LBXHDD)

# HDL 
hdl = 
  stack_nhanes_data(pattern ='HDL') %>% 
  select(SEQN,
         cycle,
         LBDHDD)

# Cotinine 
cot = 
  stack_nhanes_data(pattern = paste(c('LAB06', 'L06_B', 'L06COT_C', 'COT_D', 'COTNAL_E', 'COTNAL_F', 'COTNAL_G', 'COT_H'), collapse = "|")) %>% 
  select(SEQN,
         cycle,
         LBXCOT)

# Glycohemoglobin 
glyc = 
  stack_nhanes_data(pattern = paste(c('LAB10.csv', 'L10_B', 'L10_C', 'GHB'), collapse = "|")) %>% 
  select(SEQN,
         cycle,
         LBXGH)

# Medical Conditions 
mcq = 
  stack_nhanes_data(pattern = 'MCQ') %>% 
  select(SEQN,
         cycle,
         MCQ160A,
         MCQ160B,
         MCQ160C,
         MCQ160D,
         MCQ160E,
         MCQ160F,
         MCQ180A,
         MCQ190)

# Oral Glucose Tolerance Test 
ogt = 
  stack_nhanes_data(pattern = 'OGTT') %>% 
  select(SEQN,
         cycle,
         LBXGLT)

# Plasma Fasting Glucose
glu = 
  stack_nhanes_data(pattern = paste(c('LAB10AM', 'L10AM_B', 'L10AM_C', 'GLU'), collapse = "|")) %>% 
  select(SEQN,
         cycle,
         LBXGLU)

############
# CHECKING #
############

bind_rows('DEMO - Demographic and Weights' = demo, 
          'BPX - Blood Pressure' = bpx, 
          'BPQ - Blood Pressure & Cholesterol' = bpq, 
          'SMQ - Smoking' = smq,
          'DIQ - Diabetes' = diq,
          'RHQ - Reproductive Health' = rhq, 
          'L13 + CHOL - Cholesterol' = chol,
          'MCQ - Medical Conditions' = mcq,
          'HDL' = hdl,
          'Cotinine' = cot, 
          'Glycohemoglobin' = glyc,
          'Glucose Tolerance Test' = ogt,
          'Fasting Glucose' = glu,
          .id = 'Database') %>% 
  select(Database, cycle) %>% 
  group_by(Database, cycle) %>% 
  summarise(n = n()) %>% 
  spread(key = cycle, value = n) %>% 
  ungroup() %>% 
  mutate(Total = rowSums(.[,2:9], na.rm = TRUE)) %>% 
  arrange(desc(Total)) %>% 
  kable(format.args = list(big.mark = ",")) %>% 
  kable_styling()

```

### Downloading and reading mortality data

The mortality files were downloaded from [here](ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/). The codes below are based on the R code provided by in [Linked mortality files website](https://www.cdc.gov/nchs/data-linkage/mortality-public.htm).

```{r}

# Downloaded the files and saved in a local repo:
data_path = '../3 - Databases/mortality_data'

# Function to read the downloaded mortality dataset based on code from LMF website:
read_mortality_data = function(data_name){
  
  cycle = substr(data_name,40,48)
    
  dsn <- 
    read_fwf(file=data_name,
                  col_types = "ciiiiiiiddii",
                  fwf_cols(publicid = c(1,14),
                           eligstat = c(15,15),
                           mortstat = c(16,16),
                           ucod_leading = c(17,19),
                           diabetes = c(20,20),
                           hyperten = c(21,21),
                           dodqtr = c(22,22),
                           dodyear = c(23,26),
                           wgt_new = c(27,34),
                           sa_wgt_new = c(35,42),
                           permth_int = c(43,45),
                           permth_exm = c(46,48)
                  ),
                  na = ".") %>% 
    mutate(SEQN = as.numeric(substr(publicid,1,5)), # create the ID (SEQN) for the NHANES surveys
           cycle = sub("_", "-", cycle)) %>% 
    select(-c(publicid, dodqtr, dodyear, wgt_new, sa_wgt_new)) # Drop NHIS variables
  
  return(dsn)

}

# Function to stack mortality datasets

stack_mort_data = function(path){
  
  data_names = list.files(path = path)
  
  db = 
    lapply(paste(path, data_names, sep = '/'), read_mortality_data) %>% 
    bind_rows()
  
  return(db)
}


mortality = stack_mort_data(path = data_path)

############
# CHECKING #
############

mortality %>% 
  group_by(cycle) %>% 
  summarise(n = n()) %>% 
  bind_rows(data.frame(cycle = 'Total', n = dim(mortality)[1], stringsAsFactors = FALSE)) %>% 
  kable(format.args = list(big.mark = ",")) %>% 
  kable_styling()

```

### Merging datasets

PS: Using also cycle as key (even though not needed) to avoind duplicating this variable across datasets.

```{r}

nhanes = 
  demo %>% 
  left_join(bpq, by = c('SEQN', 'cycle')) %>% 
  left_join(bpx, by = c('SEQN', 'cycle')) %>% 
  left_join(chol, by = c('SEQN', 'cycle')) %>% 
  left_join(cot, by = c('SEQN', 'cycle')) %>% 
  left_join(diq, by = c('SEQN', 'cycle')) %>% 
  left_join(glu, by = c('SEQN', 'cycle')) %>% 
  left_join(glyc, by = c('SEQN', 'cycle')) %>% 
  left_join(hdl, by = c('SEQN', 'cycle')) %>% 
  left_join(mcq, by = c('SEQN', 'cycle')) %>% 
  left_join(ogt, by = c('SEQN', 'cycle')) %>% 
  left_join(rhq, by = c('SEQN', 'cycle')) %>% 
  left_join(smq, by = c('SEQN', 'cycle')) %>% 
  left_join(mortality, by = c('SEQN', 'cycle'))
  
saveRDS(nhanes, file = 'nhanes_mort_complete.rds')
write.csv(nhanes, file = 'nhanes_mort_complete.csv', row.names = FALSE)

```

### Selecting study population

#### Study population

* Women (RIAGENDR) 
* Age 40-79 (RIDAGEYR)
* No history of cardiovascular disease at baseline including:
    + Congestive Heart Failure (MCQ160B)
    + Coronary Heart Disease (MCQ160C)
    + Angina (MCQ160D)
    + Heart Attack (MCQ160E)
    + Stroke (MCQ160F)
* No pregnancy history, including current pregnancy (RHD130/RHQ131)

#### Gender distribution

```{r}

nhanes %>% 
  mutate(RIAGENDR = car::Recode(RIAGENDR, "1 = 'Male'; 2 = 'Female'")) %>% 
  group_by(RIAGENDR) %>% 
  summarise(n = n()) %>% 
  mutate(freq = n/sum(n)*100) %>% 
  bind_rows(data.frame(RIAGENDR = 'Total', n = dim(nhanes)[1], freq = 100, stringsAsFactors = FALSE)) %>% 
  kable(format.args = list(big.mark = ","), align=rep('c', 3), digits = 2) %>% 
  kable_styling()

```

#### Selecting Females:

```{r}
cvd = 
  nhanes %>% 
  filter(RIAGENDR == 2) # Female

cvd %>% 
  mutate(RIDAGEYR_cat = ifelse(RIDAGEYR < 40, '< 40',
                               ifelse(RIDAGEYR > 79, '> 79', '40 - 79'))) %>% 
  group_by(RIDAGEYR_cat) %>% 
  summarise(n = n()) %>% 
  mutate(freq = n/sum(n)*100) %>% 
  bind_rows(data.frame(RIDAGEYR_cat = 'Total', n = dim(cvd)[1], freq = 100, stringsAsFactors = FALSE)) %>% 
  kable(format.args = list(big.mark = ","), align=rep('c', 3), digits = 2) %>% 
  kable_styling()

```

#### Selecting ages 40-79:

```{r}
cvd2 = 
  cvd %>% 
  filter(RIDAGEYR >= 40,
         RIDAGEYR <= 79) %>% # Ages 40 - 79
    mutate_at(vars(MCQ160B,
                 MCQ160C,
                 MCQ160D,
                 MCQ160E,
                 MCQ160F),
            funs(ifelse(. == 1, 1, 0))) %>% 
  rowwise %>% 
  mutate(MCQ160_TOTAL = sum(MCQ160B,
                            MCQ160C,
                            MCQ160D,
                            MCQ160E,
                            MCQ160F),
         CVD = ifelse(MCQ160_TOTAL > 0, 'Yes', 'No')) %>% 
  ungroup

cvd2 %>% 
  group_by(CVD) %>% 
  summarise(n = n()) %>% 
  mutate(freq = n/sum(n)*100) %>% 
  bind_rows(data.frame(CVD = 'Total', n = dim(cvd2)[1], freq = 100, stringsAsFactors = FALSE)) %>% 
  kable(format.args = list(big.mark = ","), align=rep('c', 3), digits = 2) %>% 
  kable_styling()

```

#### Excluding women with history of CVD:

```{r}
cvd3 =
  cvd2 %>%
  filter(CVD == 'No')
  
cvd3 %>% 
  group_by(RHD130) %>% 
  summarise(n = n()) %>% 
  mutate(freq = n/sum(n)*100) %>% 
  mutate(RHD130 = car::Recode(RHD130, "1 = 'Yes'; 2 = 'No'; 7 = 'Refused'; 9 = 'Do not know'")) %>%
  bind_rows(data.frame(RHD130 = 'Total', n = dim(cvd3)[1], freq = 100, stringsAsFactors = FALSE)) %>% 
  kable(format.args = list(big.mark = ","), align=rep('c', 3), digits = 2) %>% 
  kable_styling()

cvd3 %>% 
  group_by(RHQ131) %>% 
  summarise(n = n()) %>% 
  mutate(freq = n/sum(n)*100) %>% 
  mutate(RHQ131 = car::Recode(RHQ131, "1 = 'Yes'; 2 = 'No'; 7 = 'Refused'; 9 = 'Do not know'")) %>% 
  bind_rows(data.frame(RHQ131 = 'Total', n = dim(cvd3)[1], freq = 100, stringsAsFactors = FALSE)) %>% 
  kable(format.args = list(big.mark = ","), align=rep('c', 3), digits = 2) %>% 
  kable_styling()

```

#### Selecting women with pregnancy history:

```{r}
cvd4 =
  cvd3 %>%
  filter(RHQ131 == 1 | RHD130 == 1) %>% 
  select(-c(MCQ160_TOTAL, CVD))

```

Final target population has `r dim(cvd4)[1]` observations and `r dim(cvd4)[2]` variables extracted from NHANES and NDI mortality files.

## Variable construction

### Variable construction

### Outcome

### Sample weights
